default:
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker info

stages:
  - build

build-image:
  stage: build
  tags:
    - shiba
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
  script:
    - apk add --update --no-cache git
    - docker login -u $DOCKER_USER -p $DOCKER_TOKEN
    - docker buildx create --name builder --bootstrap --use
    - docker compose version
    - echo "GIT_SHA=$(git rev-parse --short HEAD)" >> ./.env
    - docker compose build --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') --push
    - docker buildx rm builder
